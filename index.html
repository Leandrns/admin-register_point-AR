<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>AR Hit Test Simples</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true; colorManagement: true;"
    xrweb="optionalFeatures: hit-test"
  >
    <!-- Luz para o objeto -->
    <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
    <a-light type="directional" position="0 1 1" intensity="0.6"></a-light>

    <!-- Reticle para indicar superfície detectada -->
    <a-entity id="reticle" visible="false" geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.06" material="color: lime; shader: flat" rotation="-90 0 0"></a-entity>

    <!-- Espaço para colocar a esfera -->
    <a-entity id="placed-object"></a-entity>

    <a-camera id="camera" camera position="0 1.6 0" look-controls></a-camera>
  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const camera = document.querySelector('#camera');
    const reticle = document.querySelector('#reticle');
    const placedObject = document.querySelector('#placed-object');

    let xrSession = null;
    let xrReferenceSpace = null;
    let viewerReferenceSpace = null;
    let hitTestSource = null;

    scene.addEventListener('enter-vr', async () => {
      if (navigator.xr) {
        xrSession = scene.xrSession;

        if (!xrSession) return;

        // Referência espacial para o mundo
        xrReferenceSpace = await xrSession.requestReferenceSpace('local');

        // Espaço do visualizador para hit test
        viewerReferenceSpace = await xrSession.requestReferenceSpace('viewer');

        // Pede a fonte de hit test
        hitTestSource = await xrSession.requestHitTestSource({ space: viewerReferenceSpace });

        // Mostra o reticle
        reticle.setAttribute('visible', false);

        // Loop para atualizar a posição do reticle
        xrSession.requestAnimationFrame(onXRFrame);
      }
    });

    // Função que atualiza frame XR
    function onXRFrame(time, frame) {
      let session = frame.session;
      session.requestAnimationFrame(onXRFrame);

      const hitTestResults = frame.getHitTestResults(hitTestSource);

      if (hitTestResults.length > 0) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(xrReferenceSpace);

        // Posiciona o reticle onde o hit test detectou a superfície
        reticle.object3D.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
        reticle.object3D.quaternion.set(pose.transform.orientation.x, pose.transform.orientation.y, pose.transform.orientation.z, pose.transform.orientation.w);
        reticle.setAttribute('visible', true);
      } else {
        reticle.setAttribute('visible', false);
      }
    }

    // Evento para colocar o objeto quando tocar na tela
    window.addEventListener('click', () => {
      if (reticle.getAttribute('visible')) {
        const pos = reticle.object3D.position;
        const quat = reticle.object3D.quaternion;

        placedObject.setAttribute('position', pos);
        placedObject.setAttribute('rotation', {
          x: 0,
          y: THREE.Euler().setFromQuaternion(quat).y * (180 / Math.PI),
          z: 0
        });

        // Adiciona uma esfera se ainda não tiver
        if (!placedObject.querySelector('a-sphere')) {
          const sphere = document.createElement('a-sphere');
          sphere.setAttribute('radius', '0.1');
          sphere.setAttribute('color', '#FF0000');
          placedObject.appendChild(sphere);
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
</body>
</html>
