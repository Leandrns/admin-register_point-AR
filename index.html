<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Registro de Ponto sem Marcador</title>
		<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
	</head>
	<body style="margin: 0; overflow: hidden">
		<button
			id="registerBtn"
			style="position: fixed; top: 10px; left: 10px; z-index: 2"
		>
			Ativar AR
		</button>

		<a-scene
			vr-mode-ui="enabled: false"
			embedded
			renderer="colorManagement: true"
			xrweb="requiredFeatures: hit-test"
			webxr="optionalFeatures: hit-test"
			id="scene"
		>
			<a-entity camera position="0 1.6 0" look-controls></a-entity>
			<a-entity id="pontos"></a-entity>
		</a-scene>

		<script>
			let xrSession = null;
			let hitTestSource = null;
			const pontosEl = document.getElementById("pontos");
			const pontosRegistrados = [];

			document.getElementById("registerBtn").addEventListener("click", async () => {
				const sceneEl = document.getElementById("scene");

				// Solicita uma sessÃ£o de AR
				xrSession = await navigator.xr.requestSession("immersive-ar", {
					requiredFeatures: ["hit-test", "local-floor"],
				});

				const xrRefSpace = await xrSession.requestReferenceSpace("local-floor");
				const viewerSpace = await xrSession.requestReferenceSpace("viewer");
				hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

				xrSession.addEventListener("select", (event) => {
					if (lastHitPos) {
						pontosRegistrados.push(lastHitPos.clone());
						criarEsfera(lastHitPos);
						console.log("Ponto registrado:", pontosRegistrados);
					}
				});

				sceneEl.renderer.xr.setSession(xrSession);

				let lastHitPos = null;

				xrSession.requestAnimationFrame(function onXRFrame(time, frame) {
					const referenceSpace = xrRefSpace;
					const hitTestResults = frame.getHitTestResults(hitTestSource);

					if (hitTestResults.length > 0) {
						const pose = hitTestResults[0].getPose(referenceSpace);
						lastHitPos = pose.transform.position;
					}

					xrSession.requestAnimationFrame(onXRFrame);
				});
			});

			function criarEsfera(pos) {
				const sphere = document.createElement("a-sphere");
				sphere.setAttribute("radius", "0.1");
				sphere.setAttribute("color", "blue");
				sphere.object3D.position.set(pos.x, pos.y, pos.z);
				pontosEl.appendChild(sphere);
			}
		</script>
	</body>
</html>
